---
title: "Indicator: Cumulative number of alien species"
author:
- Damiano Oldoni
- Sander Devisscher
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how to build indicators of Invasive Alien Species based on checklist data. In particular, this document takes into account:

1. pathways associated with alien species introductions (see GitHub isue [#19](https://github.com/trias-project/pipeline/issues/19))

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Install `trias` package:

```{r install_packages}
devtools::install_github("trias-project/trias")
devtools::install_github("thomasp85/patchwork")
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(tidyr)
library(dplyr)
library(magrittr)
library(stringr)
library(readr)
library(ggplot2)
# GBIF related packages
library(rgbif)
# project package
library(trias)
#other pckages
library(lazyeval)
library(INBOtheme)
library(assertthat)
```

# Get data

```{r save_data_output}
data <- read_tsv("../data/interim/test_data_output_checklist_indicators.tsv")

```

# Build indicators

## Introduction

New functions should be written in `trias` official project package.

In order to not consider subspecies, please take care of grouping by `species` (see point 8 of [#21](https://github.com/trias-project/pipeline/issues/21)).

About point 7 of [#21](https://github.com/trias-project/pipeline/issues/21), please see this [comment](https://github.com/trias-project/pipeline/issues/21#issuecomment-381164874).

## Number of alien species

see GitHub issue [#20](https://github.com/trias-project/pipeline/issues/20)

```{r}
multiplot <- function(..., plotlist=NULL, file, cols=2, layout=NULL) {
 library(grid)

 # Make a list from the ... arguments and plotlist
 plots <- c(list(...), plotlist)

 numPlots = length(plots)

 # If layout is NULL, then use 'cols' to determine layout
 if (is.null(layout)) {
   # Make the panel
   # ncol: Number of columns of plots
   # nrow: Number of rows needed, calculated from # of cols
   layout <- matrix(c(1,1,2,2))
 }

if (numPlots==1) {
   print(plots[[1]])

 } else {
   # Set up the page
   grid.newpage()
   pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

   # Make each plot, in the correct location
   for (i in 1:numPlots) {
     # Get the i,j matrix positions of the regions that contain this subplot
     matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

     print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                     layout.pos.col = matchidx$col))
   }
 }
}
```

```{r determine_presence_per_specieskey_per_year}

indicator_total_year <- function(df, start_year_plot = 1940, 
                                 x_scale_stepsize = 10, 
                                 facet_column = NULL) {
    
    # initial input checks
    assert_that(is.data.frame(df))
    
    # prepare the data set, !recheck when issue #30 cleared out
    if (is.null(facet_column)) {
        df_cleaned <- df %>%
            distinct_("key", "startDate", "endDate")
    } else {
        # check for valid facet options
        valid_facet_options <- c("family", "order", "class", "phylum", 
                                 "kingdom", "pathway_level1", "locality", 
                                 "native_range")
        facet_column <- match.arg(facet_column, valid_facet_options) 
        
        df_cleaned <- df %>%
            distinct_("key", "startDate", "endDate", facet_column)
    }
    df_cleaned <- df_cleaned %>%
        filter(!is.na(startDate)) %>%  # ignore information without startDate
        replace_na(list(endDate = lubridate::year(lubridate::now()))) # replace NA with current year    
    
    # Make individual records for each year within the range    
    df_extended <- df_cleaned %>%
        rowwise() %>%
        do(year = .data$startDate:.data$endDate) %>%
        bind_cols(df_cleaned) %>% 
        unnest(year)
    
    maxDate <- max(df_extended$year)
    top_graph <- ggplot(df_extended, aes(x = year)) +
        geom_line(stat = "count") +
        xlab("Year") +
        ylab("Number of alien species") +
        scale_x_continuous(breaks = seq(start_year_plot, maxDate, 
                                        x_scale_stepsize),
                           limits = c(start_year_plot, maxDate)) +
        theme_inbo()
    
    if (is.null(facet_column)) {
        return(top_graph)
    } else {
        # calculate numbers
        counts_ias_grouped <- df_extended %>%
            group_by_("year", facet_column)  %>%
            count() %>%
            ungroup()

        # ISSUE starts here...
        facet_graph <- ggplot(counts_ias_grouped, 
                              aes(x = year, y = n)) + 
            geom_line() +
            xlab("Year") +
            ylab("Number of alien species") +
            facet_wrap(facet_column) + 
            scale_x_continuous(breaks = seq(start_year_plot, maxDate, 
                                        x_scale_stepsize),
                               limits = c(start_year_plot, maxDate)) +
            theme_inbo()
        
        top_graph + facet_graph + plot_layout(ncol = 1, heights = c(1, 4))
    }    
            
    
}
```

```{r}
start_year_plot <- 1900
x_scale_stepsize <- 25

indicator_total_year(data, start_year_plot, x_scale_stepsize, 
                     facet_column = "kingdom")
```
