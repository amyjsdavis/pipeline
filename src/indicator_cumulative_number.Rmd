---
title: "Indicator: Cumulative number of alien species"
author:
- Damiano Oldoni
- Sander Devisscher
- Stijn Vanhoey
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how to build indicators of Invasive Alien Species based on checklist data. In particular, this document takes into account:

1. pathways associated with alien species introductions (see GitHub isue [#19](https://github.com/trias-project/pipeline/issues/19))

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = FALSE)
```

Install `trias` package:

```{r install_packages}
devtools::install_github("trias-project/trias")
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(tidyr)
library(dplyr)
library(magrittr)
library(stringr)
library(readr)
library(ggplot2)
# GBIF related packages
library(rgbif)
# project package
library(trias)
#other pckages
library(lazyeval)
library(INBOtheme)
library(assertthat)
library(assertable)
library(egg)
```

# Get data

```{r save_data_output}
data <- read_tsv("../data/interim/test_data_output_checklist_indicators.tsv")

```
# Build indicators

## Introduction

New functions should be written in `trias` official project package.

In order to not consider subspecies, please take care of grouping by `species` (see point 8 of [#21](https://github.com/trias-project/pipeline/issues/21)).

About point 7 of [#21](https://github.com/trias-project/pipeline/issues/21), please see this [comment](https://github.com/trias-project/pipeline/issues/21#issuecomment-381164874).

## Number of alien species

see GitHub issue [#20](https://github.com/trias-project/pipeline/issues/20)

```{r determine_presence_per_specieskey_per_year}

#' Create total invasive species indicator plot (Trias)
#'
#' @param df data.frame Contains the data as produced by the Trias pipeline,
#' with minimal colums.
#' @param start_year_plot int Limit to use as start year of the plot. For scientific
#' usage, the entire period could be relevant, but for policy purpose, focusing
#' on a more recent period could be required.
#' @param x_scale_stepsize int On which year interval labels are placed 
#' on the x axis.
#' @param facet_column NULL | char The column to use to create additional
#' facet wrap plots underneath the main graph. When NULL, no facet graph is
#' included.
#'
#' @return ggplot2 object
#' @export
#' @importFrom assertthat assert_that
#' @importFrom assertable assert_colnames
#' @importFrom dplyr distinct_ %>% filter rowwise do bind_cols group_by_ 
#' count ungroup
#' @importFrom tidyr replace_na unnest
#' @importFrom lubridate year now
#' @importFrom ggplot2 geom_line aes xlab ylab scale_x_continuous facet_wrap
#' @importFrom INBOtheme theme_inbo
#' @importFrom egg ggarrange
#'
#' @examples
indicator_total_year <- function(df, start_year_plot = 1940, 
                                 x_scale_stepsize = 10, 
                                 facet_column = NULL) {
    
    # initial input checks
    assert_that(is.data.frame(df))
    assert_colnames(df, c("key", "first_observed", "endDate"), 
                    only_colnames = FALSE)
    
    # prepare the data set, !recheck when issue #30 cleared out
    if (is.null(facet_column)) {
        df_cleaned <- df %>%
            distinct_("key", "first_observed", "endDate")
    } else {
        # check for valid facet options
        valid_facet_options <- c("family", "order", "class", "phylum", 
                                 "kingdom", "pathway_level1", "locality", 
                                 "native_range")
        facet_column <- match.arg(facet_column, valid_facet_options) 
        
        df_cleaned <- df %>%
            distinct_("key", "first_observed", "endDate", facet_column)
    }

    # Provide warning messages for endDate/first_observed NA values
    if (nrow(filter(df, is.na(first_observed), is.na(endDate))) > 0) {
        warning("Some records have no first_observed or endDate defined, ",
                "these are currently not taken into account")
    }        
    if (nrow(filter(df, !is.na(first_observed), is.na(endDate))) > 0) {
        warning("Some records have a first_observed, but endDate is not defined, ",
                "using same year as startYear to replace NA")
    }
    df_cleaned <- df_cleaned %>%
        filter(!is.na(first_observed)) %>%  # ignore information without first_observed
        mutate(endDate = if_else(is.na(endDate), first_observed, endDate)) # replace NA with first_observed
    
    # Make individual records for each year within the range    
    df_extended <- df_cleaned %>%
        rowwise() %>%
        do(year = .data$first_observed:.data$endDate) %>%
        bind_cols(df_cleaned) %>% 
        unnest(year)
    
    maxDate <- max(df_extended$year)
    top_graph <- ggplot(df_extended, aes(x = year)) +
        geom_line(stat = "count") +
        xlab("Year") +
        ylab("Number of alien species") +
        scale_x_continuous(breaks = seq(start_year_plot, maxDate, 
                                        x_scale_stepsize),
                           limits = c(start_year_plot, maxDate)) +
        theme_inbo()
    
    if (is.null(facet_column)) {
        return(top_graph)
    } else {
        # calculate numbers
        counts_ias_grouped <- df_extended %>%
            group_by_("year", facet_column)  %>%
            count() %>%
            ungroup()

        # ISSUE starts here...
        facet_graph <- ggplot(counts_ias_grouped, 
                              aes(x = year, y = n)) + 
            geom_line() +
            xlab("Year") +
            ylab("Number of alien species") +
            facet_wrap(facet_column) + 
            scale_x_continuous(breaks = seq(start_year_plot, maxDate, 
                                        x_scale_stepsize),
                               limits = c(start_year_plot, maxDate)) +
            theme_inbo()

        ggarrange(top_graph, facet_graph)
    }    
            
    
}
```

So, the figure can be created without using facets (default):

```{r fig.width=10, fig.height=5}
start_year_plot <- 1900
x_scale_stepsize <- 25
indicator_total_year(data, start_year_plot, x_scale_stepsize)
```

or with the facet usage:

```{r fig.width=8, fig.height=8}
start_year_plot <- 1900
x_scale_stepsize <- 25

indicator_total_year(data, start_year_plot, x_scale_stepsize, 
                     facet_column = "kingdom")
```
