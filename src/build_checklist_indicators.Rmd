---
title: "Cheklist-based indicators of Invasive Alien Species"
author:
- Damiano Oldoni
- Add your name
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how to build indicators of Invasive Alien Species based on checklist data. In particular, the following indicators are taken into account:

1. number of new introductions of alien species per year in Belgium (see GitHub issue [#17](https://github.com/trias-project/pipeline/issues/17))
2. pathways associated with alien species introductions (see GitHub isue [#19](https://github.com/trias-project/pipeline/issues/19))
3. cumulative number of alien species (see GitHub issue [#20](https://github.com/trias-project/pipeline/issues/20))

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Install `trias` package:

```{r install_packages}
devtools::install_github("trias-project/trias")
```


Load libraries:

```{r load_libraries}
# Tidyverse packages
library(tidyr)
library(dplyr)
library(magrittr)
library(stringr)
library(readr)
# GBIF related packages
library(rgbif)
# project package
library(trias)
#other pckages
library(lazyeval)
```

# Get data

One of the TrIAS goals is to unify seven authoritative checklists. Such unified cheklist, public on GBIF (Global Biodiversity Information Facility) would be the start point of this workflow. However, we still don't have such checklist. We can still further work based on data of three different checklists

1. [Manual of the Alien Plants of Belgium](https://www.gbif.org/dataset/9ff7d317-609b-4c08-bd86-3bc404b77c42)
2. [Inventory of alien macroinvertebrates in Flanders, Belgium](https://www.gbif.org/dataset/289244ee-e1c1-49aa-b2d7-d379391ce265)
3. [Checklist of non-native freshwater fishes in Flanders, Belgium](https://www.gbif.org/dataset/98940a79-2bf1-46e6-afd6-ba2e85a26f9f)

## Retrieve data in checklist(s) from GBIF

First step is importing checklists data from GBIF. We do it via  `trias` function `gbif_get_taxa`

```{r get_taxa}
checklist_info <- c("key", "nubKey", "scientificName", "datasetKey")
taxon <- trias::gbif_get_taxa(
  checklist_keys = c("9ff7d317-609b-4c08-bd86-3bc404b77c42",
                     "289244ee-e1c1-49aa-b2d7-d379391ce265",
                     "98940a79-2bf1-46e6-afd6-ba2e85a26f9f"),
  origin = "SOURCE", 
  limit = 99999) %>%
  select(one_of(checklist_info))
```

Extract taxonomic information from GBIF taxonomic backbone checklist. Only taxa found in GBIF backbone will be taken into account (see GitHub issue [#21](https://github.com/trias-project/pipeline/issues/21))

```{r retrieve_taxonomic_info_backbone}
taxon_keys <- taxon %>% select(key) %>% pull(key)
taxon_info <- c("key", "species", "genus", "family", "order",
                 "class", "phylum", "kingdom",
                 "rank", "taxonomicStatus", "acceptedKey", "accepted")

nub_keys <- taxon %>% select(nubKey) %>% filter(is.finite(nubKey))
taxon_backbone_info <-  nub_keys %>%
  rowwise() %>%
  do_(interp(~ name_usage(key = .$nubKey,
                         return = "data"))) %>%
  select(key,one_of(taxon_info))

combined_taxon_info <- taxon %>% inner_join(taxon_backbone_info,
                                           by = c("nubKey" = "key"))
```

Extract distribution information

```{r retrieve_distribution_information}
distribution <- data.frame(key = taxon_keys) %>%
  rowwise() %>%
  do_(interp(~ as.data.frame(rgbif::name_usage(key = .$key,
                                               return = "data",
                                               data = "distribution"))))
```

Extract description information

```{r retrieve_description_information}
description <- data.frame(key = taxon_keys) %>%
  rowwise() %>%
  do_(interp(~ as.data.frame(rgbif::name_usage(key = .$key,
                                               return = "data",
                                               data = "description")))) %>%
  select(-c(key, language))
```

Extract species profile

```{r retrieve_species_profile_information}
speciesProfiles <- data.frame(key = taxon_keys) %>%
  rowwise() %>%
  do_(interp(~ as.data.frame(rgbif::name_usage(key = .$key,
                                               return = "data",
                                               data = "speciesProfiles"))))
```

Merge all retrieved informations

```{r merge_extensions_information}
merged_extensions <- full_join(distribution,
                               description,
                               speciesProfiles,
                               by = "taxonKey")

merged_info <- full_join(combined_taxon_info, merged_extensions,
                         by = c("key" = "taxonKey"))
```

## Filter invasive alien species

Filter species by:

1. invasion stage (`establishmentMeans` equal to `INTRODUCED`)
2. presence status (`satus` equal to `PRESENT`)
3. presence in Belgium (`country` equal to `BE`)

```{r filter_by_establishmentMeans}
print("write here your code, Damiano!")
```

## Tidy data

Split `temporal` in `first_observed` and `last_observed`:

```{r split_temporal}
print("write here your code, Damiano!")
```

Divide pathway in `pathway_level1` and `pathway_level2`. Notice that pathway is not a column but a subset of values of column `type`:

```{r split_pathway}
print("write here your code, Damiano!")
```

Save final data.frame

```{r save_data_output, eval=FALSE}
write_tsv(x = merged_info, 
          path = "../data/interim/test_data_output_checklist_indicators.tsv")
```


# Build indicators

You can start from this point and not repeat previous steps by loading the tsv file saved at the end of previous section:

```{r read_data_output, eval=FALSE}
data_output <- read_tsv(
  file = "../data/interim/test_data_output_checklist_indicators.tsv")
```

New functions should be written in `trias` official project package.

In order to not consider subspecies, please take care of grouping by `species` (see point 8 of [#21](https://github.com/trias-project/pipeline/issues/21)).

About point 7 of [#21](https://github.com/trias-project/pipeline/issues/21), please see this [comment](https://github.com/trias-project/pipeline/issues/21#issuecomment-381164874).

## Number of new introductions of alien species per year

See GitHub issue [#17](https://github.com/trias-project/pipeline/issues/17).

## Pathways associated with alien species introductions

see GitHub isue [#19](https://github.com/trias-project/pipeline/issues/19)

## Cumulative number of alien species

see GitHub issue [#20](https://github.com/trias-project/pipeline/issues/20)
