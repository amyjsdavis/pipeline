---
title: "Indicator: Number of new introductions of alien species per year"
author:
- Damiano Oldoni
- Yasmine verzelen
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how to build indicators of Invasive Alien Species based on checklist data. In particular, this document takes into account:

1. number of new introductions of alien species per year in Belgium (see GitHub issue [#17](https://github.com/trias-project/pipeline/issues/17))

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Install `trias` package:

```{r install_packages}
devtools::install_github("trias-project/trias")
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(tidyr)
library(tidyverse)
library(dplyr)
library(magrittr)
library(stringr)
library(readr)
# GBIF related packages
library(rgbif)
# project package
library(trias)
#other pckages
library(lazyeval)
library(INBOtheme)
```

# Get data

```{r save_data_output}
# Get data
data <- read_tsv("../data/interim/test_data_output_checklist_indicators.tsv")
```

# Build indicators

## Introduction

New functions should be written in `trias` official project package.

In order to not consider subspecies, please take care of grouping by `species` 
(see point 8 of [#21](https://github.com/trias-project/pipeline/issues/21)).

About point 7 of [#21](https://github.com/trias-project/pipeline/issues/21), 
please see this [comment](https://github.com/trias-project/pipeline/issues/21#issuecomment-381164874).

## Number of new introductions of alien species per year

See GitHub issue [#17](https://github.com/trias-project/pipeline/issues/17).

Create function to visualize yearly introduction evolution

```{r}
# Create function
#' Create year of introduction based Trias indicator
#'
#' @param data df, as created by preprocessing...
#' @param start_year_plot Start year to show the plot, as initial years are 
#' mostly irrelevant
#' @param smooth_span Parameter for the applied Loess smoother, for  more 
#' information on the appropriate value, see...
#' @param x_scale_stepsize Parameter that indicates the stepsize of the x axis
#'
#' @return ggplot
#' @export
#'
#' @examples
#' indicator_introduction_year(data)
#' indicator_introduction_year(data, start_year_plot = 1940, 
#'                             smooth_span = 0.6)
indicator_introduction_year <- function(data, start_year_plot = 1940,
                                       smooth_span = 1.,
                                       x_scale_stepsize = 10,
                                       facet_column = NULL) {
    
    # first filtering of the incoming data
    data <- data %>%
        filter(!is.na(.data$startDate)) %>%
        filter(.data$type == "pathway") %>% # to recheck after issue #30
        filter(.data$startDate > start_year_plot)
        
    data_top_graph <- data %>% 
        group_by(.data$startDate) %>%
        count() %>%
        ungroup()
    
    if (not.null(facet_column)) {
        data_facet_graph <- data %>% 
            group_by_("startDate", facet_column) %>%
            ungroup()    
    }
    
    # top graph with all counts
    top_graph <- ggplot(data_plot, aes(x = startDate, y = n)) +
        geom_point(stat = 'identity') +
    geom_smooth(span = smooth_span) +
    scale_x_continuous(breaks = seq(start_year_plot, 
                                 max(data_plot$startDate), 
                                 x_scale_stepsize), 
                   limits = c(start_year_plot, 
                              max(data_plot$startDate))) +
    theme_inbo()
    
    if (is.null(facet_column)) {
      return(top_graph)
    } else {
        
        data_plot <- data %>% 
         filter(!is.na(.data$startDate)) %>%
         filter(.data$type == "pathway") %>%
         filter(.data$startDate > start_year_plot) %>%
         group_by(.data$startDate, facet_column) %>% # ISSUE!
         count() %>%
         ungroup()
        
        wrap_graph <- ggplot(data_plot, aes(x = startDate, y = n)) +
         geom_point(stat = 'identity') +
         geom_smooth(span = smooth_span) +
         scale_x_continuous(breaks = seq(start_year_plot, 
                                         max(data_plot$startDate), 
                                         x_scale_stepsize), 
                           limits = c(start_year_plot, 
                                      max(data_plot$startDate))) +
         theme_inbo() + 
         facet_wrap(facet_column)
        
        return(multiplot(top_graph, wrap_graph))
        
        return(wrap_graph)
}


 }
```

Set start_year and loess_span if you want
Specify this in the function so the function knows that it shouldn't use the 
default settings (that were specified above)
```{r}
# Example
start_year_plot <- 1960
loess_span <- 3.
x_scale_stepsize <- 15

indicator_introduction_year(data, start_year_plot = start_year_plot, 
                            smooth_span = loess_span,
                            x_scale_stepsize = x_scale_stepsize,
                            facet_column = "kingdom")
```



